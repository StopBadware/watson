@(details: ReviewDetails, user: User)
@import models.enums.ReviewStatus
@import models.enums.Role
@main("Review "+details.review.id) {
	<div class="review-nav">
	@defining(details.review.siblings) { sibs =>
		@defining(if (details.review.status.isOpen) (if (details.review.status.eq(ReviewStatus.PENDING_BAD)) "Pending" else "Open") else "Closed") { desc =>
			@defining(if (sibs("prev").isEmpty) "disabled" else "") { disabled =>
			<a href="/reviews/@sibs("prev").getOrElse(details.review.id)" role="button" class="btn btn-default" @disabled>Previous @desc</a>
			}
			@defining(if (sibs("next").isEmpty) "disabled" else "") { disabled =>
			<a href="/reviews/@sibs("next").getOrElse(details.review.id)" role="button" class="btn btn-default" @disabled>Next @desc</a>
			}
		}
	}
	</div>
	
	<div id="review-summary" class="well well-lg">
		<h3>
			<label>URI:</label>
			<a href="/uris/@details.uri.id">@details.uri.uri</a>
			@partials.clipboard(details.uri.uri)
		</h3>
		<h4><label>Created:</label><span class="unixtime-full">@details.review.createdAt</span></h4>
		<h4><label>Status:</label><span id="status" class="sbw-red review-status enum">@details.review.status</span> 
		@if(details.review.status != ReviewStatus.NEW) {
		(<span id="status-updated" class="unixtime-full">@details.review.statusUpdatedAt</span>)
		}
		</h4>
		<span id="review-id" class="non-vis" data-id="@details.review.id"></span>
		@if(user.hasRole(Role.REVIEWER)) {
			@defining(if (details.review.isOpen) "" else "disabled") { disabled =>
			<button type="button" class="btn btn-default update-review is-open" @disabled data-status="pending-bad">Bad</button>
			<button type="button" class="btn btn-default update-review is-open" @disabled data-status="closed-clean">Clean</button>
			}
		}
		@if(user.hasRole(Role.VERIFIER)) {
			@defining(if (details.review.isOpen) "" else "disabled") { disabled =>
			<button type="button" class="btn btn-default update-review is-open" @disabled data-status="closed-without-review">Close Without Review</button>
			<button type="button" class="btn btn-default update-review is-open" @disabled data-status="closed-bad">Close Bad</button>
			}
			@defining(if (details.review.status == ReviewStatus.PENDING_BAD) "" else "disabled") { disabled =>
			<button type="button" class="btn btn-default update-review is-pending-bad" @disabled data-status="rejected">Send Back</button>
			}
			@defining(if (details.review.isOpen) "disabled" else "") { disabled =>
			<button type="button" class="btn btn-default update-review is-closed" @disabled data-status="reopened">Re-Open</button>
			}
		}
		<div>
		@details.review.reviewTags.map { tagId =>
			@defining(details.tags(tagId)) { tag =>
				@if((!details.review.isOpen && !tag.openOnly) || details.review.isOpen) {
				<a href="/tags/@tag.name" class="no-dec"><span class="tag" data-tagbg="@tag.hexColor">@tag</span></a>
				}
			}
		}
		</div>
		<ul id="review-notes" class="list-style-none margin-top-1em margin-bottom-none width-100">
		@details.review.notes.map { note =>
			<li>
				<label>@note.author</label>
				<span class="unixtime-short">@note.createdAt</span>
			</li>			
		}
		</ul>
		<form id="add-review-note-form">
			<input type="text" name="review-note" id="review-note" class="input-large form-control inline width-50" placeholder="Add note">
			<button type="submit" id="add-review-note" class="btn btn-default">Add</button>
		</form>
	</div>
	<div id="review-summary-status">
	@partials.ajaxstatus("Unable to update review", "Updating review", "Review Updated")()
	</div>
	
	<div id="review-test-data" class="well well-lg watson-green-bg">
		@defining(if (user.hasRole(Role.REVIEWER)) "" else "readonly") { readonly =>
		<form id="review-test-data-box">
			<div class="inline width-100">
				<label for="badware-category">Category</label>
				<select name="badware-category" id="badware-category" class="inline form-control auto-width">
				<option value="script">Script</option>
				<option value="iframe">Iframe</option>
				<option value="redirect">Redirect</option>
				<option value="executable">Executable</option>
				</select>
				<input type="text" name="executable-hash" id="executable-hash" class="input-large form-control inline auto-width" disabled placeholder="SHA-256">
			</div>
			<textarea id="badcode" name="badcode" class="form-control keepwhite has-char-counter margin-top-1em" rows="5" placeholder="Bad Code" maxlength="4096" spellcheck="false" @readonly></textarea>
			@partials.charcounter("badcode", 4096)
			<ul id="associated-uris" class="list-style-none"></ul>
			@if(user.hasRole(Role.REVIEWER)) {
			<div class="text-right">
			@defining(details.review.id + " - " + details.uri.uri) { snapshot =>
				<h4><label>Snapshot:</label><span>@snapshot</span>@partials.clipboard(snapshot)</h4>
			}
				@defining(if (details.review.isOpen) "" else "disabled") { disabled =>
				<button type="button" class="btn btn-default" @disabled title="Saves the test data for this review">Save</button>
				<button type="button" class="btn btn-default" @disabled title="Saves the test data for this review and marks it BAD">Save -> Bad</button>
				<button type="button" class="btn btn-default" @disabled title="Saves the test data for this review, marks it BAD, and moves to the next OPEN review">Save -> Bad -> Next</button>
				}
			</div>
		}
		</form>
		}
	</div>
	<div id="review-test-data-status">
	@partials.ajaxstatus("Unable to update review", "Updating review", "Review Updated")()
	</div>
	
	<div class="well well-lg white-bg">
		<ul class="nav nav-pills panel">
			<li class="active"><a href="#goog" data-toggle="tab">Google</a></li>
			<li><a href="#vt" data-toggle="tab">VirusTotal</a></li>
			<li><a href="#dsp" data-toggle="tab">DSP</a></li>
			<li><a href="#sbwcr" data-toggle="tab">Community Reports</a></li>
			<li><a href="#scans" data-toggle="tab">Scans</a></li>
			<li><a href="#resolver" data-toggle="tab">Resolver</a></li>
		</ul>
		<div class="tab-content">
			<div class="tab-pane fade in active" id="goog">
			    <table id="reviews-rescans-table" class="table table-striped table-hover table-condensed table-sorted">
			    	<thead>
			    		<tr>
			    			<th>URI</th>
			    			<th title="Safe Browsing Diagnostics">SBD</th>
			    			<th>Status</th>
			    			<th>Rescanned At</th>
			    			<th>Requested Via</th>
			    		</tr>
			    	</thead>
			    	<tbody>
			    	@details.googleRescans.map { rescan =>
						<tr class="text-center">
							<td class="text-left"><a href="/uris/@rescan.uriId">@(details.rescanUris(rescan.uriId))</a></td>
							<td><a href="https://www.google.com/safebrowsing/diagnostic?site=@(details.rescanUris(rescan.uriId))" target="_blank">SBD</a></td>
							<td>@rescan.status</td>
							<td class="unixtime-full text-right">@rescan.rescannedAt</td>
							<td>@rescan.requestedVia</td>
						</tr>			
					}
			    	</tbody>
		    	</table>		
			</div>
			<div class="tab-pane fade" id="vt">TODO WTSN-53 VT</div>
			<div class="tab-pane fade" id="dsp">TODO WTSN-49 DSP</div>
			<div class="tab-pane fade" id="sbwcr">TODO WTSN-16 SBWCR</div>
			<div class="tab-pane fade" id="scans">TODO WTSN-24 SCANS</div>
			<div class="tab-pane fade" id="resolver">TODO WTSN-14 RESOLVER</div>
		</div>
	</div>
	
	<div class="panel panel-default">
		<div class="panel-heading">
			<h3 class="panel-title">Blacklist Events</h3>
		</div>
	    <table id="reviews-blacklist-table" class="table table-striped table-hover table-condensed table-sorted">
	    	<thead>
	    		<tr>
	    			<th>Blacklisted By</th>
	    			<th>Blacklisted From</th>
	    			<th>Blacklisted To</th>
	    		</tr>
	    	</thead>
	    	<tbody>
	    	@details.blacklistEvents.map { event =>
				<tr class="text-right">
					<td>@event.source
						<div class="inline source-icon icon-@event.source.toString.toLowerCase">
							<span class="vis-hidden">@event.source.toString</span>
						</div>
					</td>
					<td class="unixtime-full">@event.blacklistedAt</td>
					@if(event.unblacklistedAt.nonEmpty){<td class="unixtime-full">@event.unblacklistedAt.get</td>}else{<td></td>}
				</tr>			
			}
	    	</tbody>
    	</table>
	</div>
	
	@tables.requestsummaries(details.reviewRequests)
	
	<div class="panel panel-default">
		<div class="panel-heading">
			<h3 class="panel-title">Other Reviews</h3>
		</div>
	    <table id="reviews-others-table" class="table table-striped table-hover table-condensed table-sorted">
	    	<thead>
	    		<tr>
	    			<th title="click to view full review">ID</th>
	    			<th>Tags</th>
	    			<th>Created At</th>
	    			<th>Status Updated</th>
	    			<th>Status</th>
	    		</tr>
	    	</thead>
	    	<tbody>
	    	@details.otherReviews.map { review =>
				<tr class="text-center">
					<td><a href="/reviews/@review.id">@review.id</a></td>
					<td>
					@review.reviewTags.map { tagId =>
						@defining(details.tags(tagId)) { tag =>
	   					<a href="/tags/@tag.name" class="no-dec"><span class="tag" data-tagbg="@tag.hexColor">@tag</span></a>
	   					}
   					}
   					</td>
					<td class="unixtime text-right">@review.createdAt</td>
					@if(review.statusUpdatedAt!=review.createdAt){<td class="unixtime text-right">@review.statusUpdatedAt</td>}else{<td></td>}
					<td class="enum">@review.status</td>
				</tr>			
			}
	    	</tbody>
    	</table>		
	</div>	
	
}